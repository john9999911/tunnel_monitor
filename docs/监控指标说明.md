# 监控指标说明文档

本文档详细说明隧道监控系统中各个监控指标的含义和用途。

## 服务端监控指标

### 活跃连接数（Active Connections）

**指标名称**: `tunnel_server_active_connections`

**含义**: 
- 表示当前服务端正在维护的活跃隧道连接数量
- 这个数值反映了有多少个客户端（POP节点或用户机器）正在与服务端建立并保持连接
- 每个活跃连接代表一个正在使用隧道服务的客户端实例

**使用场景**:
- 监控系统负载：连接数过高可能表示系统负载过大
- 容量规划：了解当前服务的用户规模
- 故障排查：连接数异常下降可能表示服务出现问题

---

## 客户端监控指标

### RX（接收）和 TX（发送）

**指标名称**: 
- `net_interface_rx_bytes` / `net_interface_rx_bytes{iface="wg0"}`: 接收字节数
- `net_interface_tx_bytes` / `net_interface_tx_bytes{iface="wg0"}`: 发送字节数

**含义**:
- **RX (Receive)**: 从网络接口接收到的数据量（单位：字节）
  - 在客户端场景中，RX 表示从 WireGuard 接口接收到的数据
  - 对于客户端来说，RX 通常代表**下载流量**（从目标服务器接收数据）
  
- **TX (Transmit)**: 通过网络接口发送的数据量（单位：字节）
  - 在客户端场景中，TX 表示通过 WireGuard 接口发送的数据
  - 对于客户端来说，TX 通常代表**上传流量**（向目标服务器发送数据）

**带宽计算**:
```promql
# 接收带宽（Mbps）
rate(net_interface_rx_bytes{iface="wg0"}[1m]) * 8 / 1000000

# 发送带宽（Mbps）
rate(net_interface_tx_bytes{iface="wg0"}[1m]) * 8 / 1000000
```

**使用场景**:
- 监控网络流量使用情况
- 识别流量异常（如流量突然激增）
- 带宽限制和流量控制

---

### Active Connection（活跃连接）

**指标名称**: `active_user_connections`

**含义**:
- 表示客户端当前维护的活跃用户连接数
- 这个数值反映了有多少个用户会话或连接正在通过该客户端进行数据传输
- 在隧道系统中，一个活跃连接通常对应一个用户配置的隧道规则

**类型区分**:
- `src` (source): 作为源端的活跃连接数
- `dst` (destination): 作为目标端的活跃连接数

**使用场景**:
- 监控客户端的连接负载
- 评估是否需要扩展客户端实例
- 故障排查：连接数异常可能表示配置同步问题

---

## 流量控制（TC）相关概念

### 为什么 wg0 egress 会有两个 mark？

在隧道系统中，为了实现双向流量控制，系统会为每个流量规则创建两个 egress mark：

**1. 第一个 mark（POP to POP）**:
- 对应：源IP → 目标IP 的流量
- 用途：控制客户端发往目标服务器的流量（上传）
- 链：POSTROUTING
- 示例：`用户IP → 目标服务器IP`

**2. 第二个 mark（POP to User，反向流量）**:
- 对应：目标IP → 源IP 的流量
- 用途：控制目标服务器返回给客户端的流量（下载）
- 链：POSTROUTING
- 示例：`目标服务器IP → 用户IP`

**为什么需要两个 mark？**
- 网络通信是双向的：客户端发送请求（上传），服务器返回响应（下载）
- 为了精确控制上传和下载的带宽，需要分别标记两个方向的流量
- 这样可以实现不对称带宽控制（例如：上传 10Mbps，下载 100Mbps）

**代码实现位置**:
- `tunnel_client/internal/tunnel/traffic/tc.go`: 创建两个 egress 规则
- 第一个规则：`EgressIpAdd("wg0", bandwidth, [userIP], [targetIPs])`
- 第二个规则（反向）：`EgressIpAdd("wg0", bandwidth, [targetIPs], [userIP])`

---

### POSTROUTING 和 PREROUTING 的含义

这是 Linux iptables/netfilter 框架中的两个网络钩子点，用于在不同的网络包处理阶段进行流量控制。

#### POSTROUTING（路由后处理）

**处理时机**: 数据包经过路由决策后，准备发送到网络接口之前

**特点**:
- 可以访问到数据包的最终源IP和目标IP
- 适用于**出口流量（Egress）**控制
- 可以修改数据包的源地址（SNAT）

**在隧道系统中的应用**:
- 用于控制**客户端发送出去的流量**（上传流量）
- 在数据包离开 WireGuard 接口之前，对其进行标记和限速
- 使用 `iptables -t mangle -A POSTROUTING` 添加规则

**示例场景**:
```
客户端 → WireGuard接口 → 目标服务器
         ↑
    在这里标记和限速（POSTROUTING）
```

#### PREROUTING（路由前处理）

**处理时机**: 数据包刚到达网络接口，还未进行路由决策

**特点**:
- 是最早处理数据包的地方
- 适用于**入口流量（Ingress）**控制
- 可以修改数据包的目标地址（DNAT）

**在隧道系统中的应用**:
- 用于控制**客户端接收到的流量**（下载流量）
- 在数据包进入 WireGuard 接口之后，立即对其进行标记和限速
- 使用 `iptables -t mangle -A PREROUTING` 添加规则

**示例场景**:
```
目标服务器 → WireGuard接口 → 客户端
                     ↑
              在这里标记和限速（PREROUTING）
```

#### 流量方向对比

| 链 | 方向 | 处理时机 | 典型用途 |
|---|---|---|---|
| PREROUTING | 入口（Ingress） | 数据包到达接口后，路由前 | 控制接收流量、目标地址转换 |
| POSTROUTING | 出口（Egress） | 数据包路由后，发送前 | 控制发送流量、源地址转换 |

**为什么需要同时使用两者？**
- **PREROUTING**: 控制客户端接收到的流量（下载）
- **POSTROUTING**: 控制客户端发送出去的流量（上传）
- 两者结合可以实现完整的双向流量控制

---

## 总结

### 指标关系图

```
服务端监控
├── 活跃连接数 (tunnel_server_active_connections)
│   └── 表示有多少客户端正在连接服务端

客户端监控
├── 网络流量
│   ├── RX (接收/下载)
│   └── TX (发送/上传)
├── 活跃连接 (active_user_connections)
│   ├── src: 作为源的连接数
│   └── dst: 作为目标的连接数
└── 流量控制 (TC)
    ├── Egress Mark (POSTROUTING)
    │   ├── 上传流量控制 (POP → POP)
    │   └── 下载流量控制 (POP → User)
    └── Ingress Mark (PREROUTING)
        └── 入口流量控制
```

### Packet Rate（数据包速率）

**指标名称**: 
- `rate(net_interface_rx_packets[1m])`: 接收数据包速率
- `rate(net_interface_tx_packets[1m])`: 发送数据包速率

**单位说明**:
- **配置单位**: `pps` (packets per second)
- **Grafana显示**: `p/s` (packets per second)

**为什么显示为 p/s？**

在 Grafana 中，单位 `pps` 会自动格式化为 `p/s` 显示，这是 Grafana 的单位格式化规则：
- `pps` → `p/s` (packets per second)
- 类似的格式化规则：
  - `bps` → `b/s` (bits per second)
  - `Bps` → `B/s` (bytes per second)
  - `ops` → `ops/s` (operations per second)

这符合 SI 单位制（国际单位制）的规范，其中斜杠 `/` 表示"每"（per）的含义。因此：
- `pps` = packets per second = 数据包/秒
- 显示为 `p/s` 是 Grafana 的标准格式化方式，表示"packets per second"

**实际含义**:
- 显示值 `1000 p/s` 表示每秒处理 1000 个数据包
- 这是网络性能监控中的常用指标，用于评估网络接口的处理能力

---

### 常见问题

**Q: 为什么数据库查询QPS和耗时显示为空？**
A: 需要在数据库查询代码中调用 `monitor.RecordDatabaseQuery()` 函数记录指标。现在已修复，所有通过 `executeQuery` 执行的查询都会自动记录指标。

**Q: 活跃连接数和 WireGuard Peers 的区别？**
A: 
- WireGuard Peers: WireGuard 协议层面的对等节点数
- 活跃连接数: 应用层面的业务连接数，可能包含多个业务会话

**Q: Packet Rate 显示为 p/s 而不是 pps？**
A: 这是 Grafana 的正常单位格式化。配置中使用的 `pps` 单位会被 Grafana 自动格式化为 `p/s` 显示，两者含义相同，都表示"packets per second"（数据包/秒）。

**Q: 如何查看实时带宽？**
A: 使用以下 PromQL 查询：
```promql
# 接收带宽（Mbps）
rate(net_interface_rx_bytes{iface="wg0"}[1m]) * 8 / 1000000

# 发送带宽（Mbps）
rate(net_interface_tx_bytes{iface="wg0"}[1m]) * 8 / 1000000
```

**Q: 如何查看数据包速率？**
A: 使用以下 PromQL 查询：
```promql
# 接收数据包速率（p/s）
rate(net_interface_rx_packets{iface="wg0"}[1m])

# 发送数据包速率（p/s）
rate(net_interface_tx_packets{iface="wg0"}[1m])
```

---

## 参考资料

- Linux Netfilter 框架: https://netfilter.org/
- WireGuard 文档: https://www.wireguard.com/
- Prometheus 查询语言: https://prometheus.io/docs/prometheus/latest/querying/basics/
- TC (Traffic Control): https://man7.org/linux/man-pages/man8/tc.8.html

