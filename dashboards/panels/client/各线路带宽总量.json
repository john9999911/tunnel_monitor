{
    "datasource": {
        "default": false,
        "type": "mysql",
        "uid": "{{MYSQL_UID}}"
    },
    "fieldConfig": {
        "defaults": {
            "color": {
                "mode": "thresholds"
            },
            "custom": {
                "align": "auto",
                "cellOptions": {
                    "type": "auto"
                },
                "inspect": false
            },
            "mappings": [],
            "thresholds": {
                "mode": "absolute",
                "steps": [
                    {
                        "color": "green",
                        "value": null
                    },
                    {
                        "color": "red",
                        "value": 80
                    }
                ]
            }
        },
        "overrides": [
            {
                "matcher": {
                    "id": "byName",
                    "options": "各线路带宽使用率"
                },
                "properties": [
                    {
                        "id": "unit",
                        "value": "percent"
                    }
                ]
            },
            {
                "matcher": {
                    "id": "byName",
                    "options": "线路"
                },
                "properties": [
                    {
                        "id": "custom.width",
                        "value": 318
                    }
                ]
            }
        ]
    },
    "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 49
    },
    "id": 1,
    "options": {
        "cellHeight": "sm",
        "footer": {
            "countRows": false,
            "fields": "",
            "reducer": [
                "sum"
            ],
            "show": false
        },
        "showHeader": true,
        "sortBy": []
    },
    "pluginVersion": "11.2.2",
    "targets": [
        {
            "dataset": "iptunnel",
            "datasource": {
                "type": "mysql",
                "uid": "{{MYSQL_UID}}"
            },
            "editorMode": "code",
            "format": "table",
            "rawQuery": true,
            "rawSql": "SELECT CONCAT(ma.alias, ' ~ ', mb.alias) AS bandwidth_line_display, bl.bandwidth_line_code, bl.total_bandwidth FROM bandwidth_lines bl JOIN machines ma ON bl.machine_a_code = ma.machine_code JOIN machines mb ON bl.machine_b_code = mb.machine_code WHERE bl.is_active=1 AND bl.deleted_at IS NULL AND ma.alias IS NOT NULL AND mb.alias IS NOT NULL AND bl.bandwidth_line_code LIKE $bandwidth_line",
            "refId": "A",
            "sql": {
                "columns": [
                    {
                        "parameters": [],
                        "type": "function"
                    }
                ],
                "groupBy": [
                    {
                        "property": {
                            "type": "string"
                        },
                        "type": "groupBy"
                    }
                ],
                "limit": 50
            }
        },
        {
            "dataset": "iptunnel",
            "datasource": {
                "type": "mysql",
                "uid": "{{MYSQL_UID}}"
            },
            "editorMode": "code",
            "format": "table",
            "hide": false,
            "rawQuery": true,
            "rawSql": "SELECT CONCAT(ma.alias, ' ~ ', mb.alias) AS bandwidth_line_display, c.bandwidth_line_code, c.user_code, SUM(c.bandwidth) AS total_bandwidth_used FROM configs c JOIN bandwidth_lines bl ON c.bandwidth_line_code = bl.bandwidth_line_code JOIN machines ma ON bl.machine_a_code = ma.machine_code JOIN machines mb ON bl.machine_b_code = mb.machine_code WHERE c.status='active' AND c.deleted_at IS NULL AND bl.deleted_at IS NULL AND ma.alias IS NOT NULL AND mb.alias IS NOT NULL AND c.bandwidth_line_code LIKE $bandwidth_line GROUP BY bandwidth_line_display, c.bandwidth_line_code, c.user_code",
            "refId": "B",
            "sql": {
                "columns": [
                    {
                        "parameters": [],
                        "type": "function"
                    }
                ],
                "groupBy": [
                    {
                        "property": {
                            "type": "string"
                        },
                        "type": "groupBy"
                    }
                ],
                "limit": 50
            }
        }
    ],
    "title": "各线路带宽总量（Mbps）",
    "transformations": [
        {
            "id": "joinByField",
            "options": {
                "byField": "bandwidth_line_display",
                "mode": "outerTabular"
            }
        },
        {
            "id": "calculateField",
            "options": {
                "binary": {
                    "left": "total_bandwidth_used",
                    "operator": "/",
                    "right": "total_bandwidth"
                },
                "mode": "binary",
                "reduce": {
                    "reducer": "sum"
                }
            }
        },
        {
            "id": "calculateField",
            "options": {
                "binary": {
                    "left": "total_bandwidth_used / total_bandwidth",
                    "operator": "*",
                    "right": "100"
                },
                "mode": "binary",
                "reduce": {
                    "reducer": "sum"
                }
            }
        },
        {
            "id": "organize",
            "options": {
                "excludeByName": {
                    "bandwidth_line_code": true,
                    "total_bandwidth_used / total_bandwidth": true,
                    "user_code": true
                },
                "includeByName": {},
                "indexByName": {},
                "renameByName": {
                    "bandwidth_line_display": "线路",
                    "total_bandwidth": "带宽总量（Mbps）",
                    "total_bandwidth_used": "带宽购买情况（Mbps）",
                    "total_bandwidth_used / total_bandwidth": "",
                    "total_bandwidth_used / total_bandwidth * 100": "各线路带宽使用率"
                }
            }
        }
    ],
    "type": "table"
}